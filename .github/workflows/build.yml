# BrainDock Build Workflow
#
# Automatically builds macOS and Windows executables when a version tag is pushed.
# Uploads the built artifacts to GitHub Releases.
#
# Usage:
#   1. Set these GitHub Secrets (Settings > Secrets > Actions):
#      - GEMINI_API_KEY (required)
#      - STRIPE_SECRET_KEY (optional, for payments)
#      - STRIPE_PUBLISHABLE_KEY (optional, for payments)
#      - STRIPE_PRICE_ID (optional, for payments)
#   2. Push a tag: git tag v1.0.0 && git push origin v1.0.0
#   3. The workflow will build both platforms and create a release
#
# The release will contain:
#   - BrainDock-macOS.zip (macOS .app bundle)
#   - BrainDock-Windows.zip (Windows .exe)

name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.
  workflow_dispatch:  # Allow manual trigger from GitHub UI
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0-test'

env:
  PYTHON_VERSION: '3.11'

jobs:
  # Build macOS app
  build-macos:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Generate icons
        run: python build/create_icons.py
      
      - name: Build with PyInstaller
        env:
          BUNDLED_GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BUNDLED_STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          BUNDLED_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          BUNDLED_STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
        run: |
          pyinstaller build/braindock.spec --noconfirm
      
      - name: Create ZIP archive
        run: |
          cd dist
          zip -r BrainDock-macOS.zip BrainDock.app
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: BrainDock-macOS
          path: dist/BrainDock-macOS.zip
          if-no-files-found: error

  # Build Windows app
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Generate icons
        run: python build/create_icons.py
      
      - name: Build with PyInstaller
        env:
          BUNDLED_GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          BUNDLED_STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          BUNDLED_STRIPE_PUBLISHABLE_KEY: ${{ secrets.STRIPE_PUBLISHABLE_KEY }}
          BUNDLED_STRIPE_PRICE_ID: ${{ secrets.STRIPE_PRICE_ID }}
        run: |
          pyinstaller build/braindock.spec --noconfirm
      
      - name: Create ZIP archive
        run: |
          cd dist
          Compress-Archive -Path BrainDock -DestinationPath BrainDock-Windows.zip
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: BrainDock-Windows
          path: dist/BrainDock-Windows.zip
          if-no-files-found: error

  # Create GitHub Release with both artifacts
  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: BrainDock-macOS
          path: ./release
      
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: BrainDock-Windows
          path: ./release
      
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.VERSION }}
          name: BrainDock ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## BrainDock ${{ steps.get_version.outputs.VERSION }}
            
            ### Downloads
            
            | Platform | Download |
            |----------|----------|
            | macOS | [BrainDock-macOS.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/BrainDock-macOS.zip) |
            | Windows | [BrainDock-Windows.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.get_version.outputs.VERSION }}/BrainDock-Windows.zip) |
            
            ### First-Time Launch Instructions
            
            **macOS:**
            1. Extract the ZIP file
            2. Move BrainDock.app to your Applications folder
            3. Right-click the app and select "Open"
            4. Click "Open" in the dialog to bypass the security warning (only needed once)
            
            **Windows:**
            1. Extract the ZIP file
            2. Run BrainDock.exe
            3. If SmartScreen appears, click "More info" then "Run anyway"
            
            ### Requirements
            - A webcam for focus monitoring
            - Internet connection for AI-powered detection
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, '-') }}
          files: |
            ./release/BrainDock-macOS.zip
            ./release/BrainDock-Windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
